# Multi-Tenant SaaS RAG Application - Setup & Testing Guide

## Prerequisites

- Python 3.10+
- Supabase account with vector store enabled
- Google Cloud account with Generative AI API enabled

## Installation Steps

### 1. Clone and Navigate to Project

```bash
cd test_technique_saas
```

### 2. Create Virtual Environment

```bash
python -m venv venv
```

**Activate the virtual environment:**
- Windows: `venv\Scripts\activate`
- Linux/Mac: `source venv/bin/activate`

### 3. Install Dependencies

```bash
pip install -r requirements.txt
```

### 4. Configure Environment Variables

Copy the `.env.example` file to `.env` and fill in your credentials:

```bash
cp .env.example .env  # Linux/Mac
copy .env.example .env  # Windows
```

Then edit `.env` with your actual credentials:

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your_supabase_service_role_key
GOOGLE_API_KEY=your_google_api_key
```

**Important:** The `.env` file is in `.gitignore` and will not be committed to version control.

### 5. Setup Supabase Database

Run these SQL commands in your Supabase SQL Editor:

**Enable pgvector extension:**
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

**Create documents table:**
```sql
CREATE TABLE documents (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  content TEXT NOT NULL,
  metadata JSONB,
  embedding vector(768)
);

CREATE INDEX ON documents USING ivfflat (embedding vector_cosine_ops);
```

**Create match_documents function:**
```sql
CREATE OR REPLACE FUNCTION match_documents (
  query_embedding vector(768),
  tenant_filter text,
  match_count int DEFAULT 3
)
RETURNS TABLE (
  id bigint,
  content text,
  metadata jsonb,
  similarity float
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    documents.id,
    documents.content,
    documents.metadata,
    1 - (documents.embedding <=> query_embedding) AS similarity
  FROM documents
  WHERE documents.metadata->>'tenant' = tenant_filter
  ORDER BY documents.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```

### 6. Generate Sample Data

```bash
python setup_files.py
```

This creates sample insurance documents in `data/client_A/` and `data/client_B/`.

### 7. Check Available Gemini Models

```bash
python check_gen.py
```

Copy one of the model names (e.g., `models/gemini-1.5-flash`) and update line 23 in `main.py`:

```python
llm = genai.GenerativeModel('models/gemini-1.5-flash')  # Use the model name from check_gen.py
```

### 8. Ingest Documents into Supabase

```bash
python ingest.py
```

This loads all documents into the vector database with tenant isolation.

### 9. Start the Backend

```bash
uvicorn main:app --reload
```

Backend runs at: `http://127.0.0.1:8000`

**Verify it's working:**
- Open `http://127.0.0.1:8000/` - Should show: `{"status": "ok"}`
- Open `http://127.0.0.1:8000/models` - Shows available Gemini models

### 10. Start the Frontend

Open a new terminal, activate venv, then run:

```bash
streamlit run app_ui.py
```

Frontend opens at: `http://localhost:8501`

---

## Testing Multi-Tenant Isolation

### Test Client A

1. **Enter API Key:** `tenantA_key`
2. **Verify Connection:** Should show "Connecté : Client A"

**Test Case 1:**
- **Question:** "Quelle est l'adresse mail pour les sinistres ?"
- **Expected Result:** Should mention `sinistres@assureur-a.fr` (from Client A's documents)
- **Pass Criteria:** Response contains Client A's email address

**Test Case 2:**
- **Question:** "Que couvre la RC Pro ?"
- **Expected Result:** Should mention exclusions of "travaux en hauteur"
- **Pass Criteria:** Response mentions height work exclusions specific to Client A

---

### Test Client B

1. **Enter API Key:** `tenantB_key`
2. **Verify Connection:** Should show "Connecté : Client B"

**Test Case 3 (Critical - Tenant Isolation):**
- **Question:** "Quelle est l'adresse mail pour les sinistres ?"
- **Expected Result:** Should mention `claims@assureur-b.com` (from Client B's documents)
- **FAIL Criteria:** If it shows `sinistres@assureur-a.fr`, tenant isolation is broken
- **Pass Criteria:** Response contains ONLY Client B's email address

**Test Case 4 (Data Isolation):**
- **Question:** "Quelle est la hauteur maximum ?"
- **Expected Result:** Should say "Je ne sais pas" or similar
- **Reason:** Height exclusion information only exists in Client A's documents
- **Pass Criteria:** Response indicates no information available (not mentioning Client A's data)

---

## Troubleshooting

### Backend won't start
- Check `.env` file exists with correct credentials
- Verify virtual environment is activated
- Run `pip install -r requirements.txt` again

### Model not found error
- Run `python check_gen.py` to see available models
- Update `main.py` line 23 with a valid model name from the list
- Restart backend with `uvicorn main:app --reload`

### No documents found
- Verify documents were ingested: Check Supabase documents table
- Re-run `python ingest.py`
- Check Supabase connection in `.env`

### Frontend can't connect to backend
- Ensure backend is running on `http://127.0.0.1:8000`
- Check firewall settings
- Verify API key is entered correctly in frontend

---

## API Keys Reference

| Tenant   | API Key       | Documents Location |
|----------|---------------|-------------------|
| Client A | `tenantA_key` | `data/client_A/`  |
| Client B | `tenantB_key` | `data/client_B/`  |

---

## Architecture Overview

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Streamlit UI   │────▶│   FastAPI       │────▶│  Supabase       │
│  (Frontend)     │     │   (Backend)     │     │  (Vector Store) │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                              │
                              ▼
                        ┌─────────────────┐
                        │  Google Gemini  │
                        │  (AI Services)  │
                        └─────────────────┘
```

**Key Features:**
- Multi-tenant data isolation via metadata filtering
- RAG (Retrieval-Augmented Generation) for accurate answers
- Vector similarity search for semantic document retrieval
- API key-based tenant authentication
